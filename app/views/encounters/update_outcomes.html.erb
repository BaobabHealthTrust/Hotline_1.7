<script type="text/javascript" type="text/javascript" src="/assets/jquery.js"></script>
<script type="text/javascript" type="text/javascript" src="/assets/top-icon.js"></script>

<script type="text/javascript">
    var tt_cancel_destination = "/patient/dashboard/<%= @patient_obj.patient_id %>/tasks";
    var selected_primary_outcomes;
    function selectedOutcomes() {
        selected_primary_outcomes = __$('touchscreenInput' + tstCurrentPage).value;

    }

    function hideselectedOutcomes(){
      var primaryOutcomes = selected_primary_outcomes.split(";");
      var liElements = document.getElementsByTagName("li");
      for (var i = 0; i<= primaryOutcomes.length - 1; i++){
        primary_outcome = primaryOutcomes[i];
        for (var j=0; j<=liElements.length -1; j++){
          li_tst_value = liElements[j].getAttribute('tstvalue');
          if (primary_outcome.trim().toUpperCase() == li_tst_value.trim().toUpperCase()){
              var img = liElements[j].getElementsByTagName('img')[0];
              if(img.src.match('unticked')){
                  liElements[j].click();
              }
            break;
          }
        }
      }
    }


    function notify_reason() {
        <% if params[:end_call] == 'true' %>
            showMessage('This call is missing outcome of call. Please record outcome of call.', false, false);
        <% end %>
    }
</script>

<style>
    #num{
        display: none;
    }
</style>

<body onLoad="notify_reason()">
    <%= form_tag("/encounters/create", id: "pregnancy-status", method: 'post', enctype: 'multipart/form-data') do %>
        <%= hidden_field_tag "encounter[encounter_type]", EncounterType.find_by_name("Update Outcome").id %>
        <%= hidden_field_tag "encounter[patient_id]", @patient_obj.patient_id %>
        <%= hidden_field_tag "encounter[encounter_datetime]", (session_date || DateTime.now()).to_s(:db) %>
        <%= hidden_field_tag "encounter[provider_id]", session[:user_id] %>


        <% if params[:show_summary]%>
            <%= hidden_field_tag 'show_summary', 'true' %>
        <% end %>

        <% @current_data = Encounter.current_data("UPDATE OUTCOME", @patient_obj.patient_id)%>

        <%= hidden_field_tag("observations[][concept_name]", "General Outcome") %>
        <%= select_tag "observations[][value_coded_or_text]", options_for_select(@general_outcomes, (@current_data['GENERAL OUTCOME'].first rescue nil)),
                       :helpText =>"Select Primary Outcome",
                       :tt_onLoad => "showHelpButton();setListAttributes();__$('keyboard').style.display='none';",
                       :tt_onUnLoad => "hideHelpButton();__$('keyboard').style.display='none';selectedOutcomes();",
                       :tt_pageStyleClass => 'longSelectList',
                       :id => "general_outcome"
        %>

        <%= hidden_field_tag("observations[][concept_name]", "Health facility name") %>
        <%= select_tag "observations[][value_text]", nil,
                           {:id => 'health_centre_name',
                            :field_type => 'alpha',
                            :condition => "__$('general_outcome').value.trim() == 'Hospital'  ||
                                __$('general_outcome').value.trim() == 'Referred to a health centre' ",
                            :helpText => 'Select health centre name',
                            :ajaxURL => '/home/health_facilities?search_string=',
                            :allowFreeText => true }%>
        <% @current_data['GENERAL OUTCOME'] = @current_data['GENERAL OUTCOME'] - [@current_data['GENERAL OUTCOME'].first] rescue nil
        %>
        <%= hidden_field_tag("observations[][concept_name]", "Secondary Outcome") %>
        <%= select_tag "observations[][value_coded_or_text]", options_for_select(@general_outcomes , (@current_data['SECONDARY OUTCOME'] rescue nil)),
                       :helpText =>"Secondary outcome if any",
                       :id => "secondary_outcome",
                       :multiple => true,
                       :optional => true,
                       :tt_onLoad => "hideselectedOutcomes();",
                       :tt_pageStyleClass => 'longSelectList',
                       :allowFreeText => false
        %>

    <% end %>
</body>
