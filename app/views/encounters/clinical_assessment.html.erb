<script type="text/javascript" type="text/javascript" src="/assets/jquery.js"></script>
<script type="text/javascript" type="text/javascript" src="/assets/top-icon.js"></script>

<script>

    var tt_cancel_destination = "/patient/dashboard/<%= @patient_obj.patient_id %>/tasks";

    var group;
    var clinical_questions = <%= raw (@clinical_questions).to_json%>;

    var answers = new Array();
    var answer;

    var answered_questions = new Array();
    var answered_question;

    function setGroup() {
        group = $('touchscreenInput'+tstCurrentPage).value;
    }

    function getGroup() {
        return group;
    }

    function getAnswers() {
        group;
        answered_questions;
        answers;
        console.log(group, answered_questions, answers);
    }

    function setAnswers(group, question) {

        answered_question = question;
        answered_questions.push(answered_question);

        answer = $('touchscreenInput'+tstCurrentPage).value;
        answers.push(answer);

        //console.log(group, answered_questions, answers);
    }

    function loadSummary() {
        var input_frame = document.getElementById('inputFrame'+tstCurrentPage);

        var table = document.createElement('table');
        input_frame.appendChild(table);

        var row = document.createElement('tr');
        table.appendChild(row);

        var col = document.createElement('td');
        col.innerHTML = group+'<br>';

        for(var i = 0; i <= answered_questions.length; i++) {
            col.innerHTML += answered_questions[i]+'';
                col.innerHTML += answers[i]+'<br>';
        }

        row.appendChild(col);
    }

</script>

<%= form_tag("/encounters/create", id: "clinical_assessment", method: 'post', enctype: 'multipart/form-data') do %>
    <%= hidden_field_tag "encounter[encounter_type]", EncounterType.find_by_name("CLINICAL ASSESSMENT").id %>
    <%= hidden_field_tag "encounter[patient_id]", @patient_obj.patient_id %>
    <%= hidden_field_tag "encounter[encounter_datetime]", (session_date || DateTime.now()).to_s(:db) %>
    <%= hidden_field_tag "encounter[provider_id]", session[:user_id] %>

    <% @current_data = Encounter.current_data("CLINICAL ASSESSMENT", @patient_obj.patient_id)%>

    <%= select_tag 'nutrition_group',
                   options_for_select(['',
                                       'Group 1',
                                       'Group 2',
                                       'Group 3',
                                       'Group 4',
                                       'Group 5',
                                       'Group 6',
                                       'Group 7'],
                                      @group),
                   :helpText =>'Target group',
                   :tt_onLoad => "showHelpButton();$('keyboard').style.display = 'none' ",
                   :tt_onUnLoad => 'hideHelpButton();setGroup();',
                   :tt_pageStyleClass => 'longSelectList',
                   :id => 'clinical_question',
                   :allowFreeText => false
    %>

    <% @clinical_questions.each do |group, clinical_questions| %>
        <% clinical_questions.each do | clinical_question| %>
            <%= hidden_field_tag('observations[][concept_name]', "#{clinical_question}") %>
            <%= select_tag 'observations[][value_coded_or_text]',
                           options_for_select(['',
                                               'Yes',
                                               'No'] ,
                                              @current_data['CLINICAL ASSESSMENT']),
                           :helpText =>"#{clinical_question}",
                           :tt_onLoad => "showHelpButton();getGroup();$('keyboard').style.display = 'none';getAnswers();",
                           :tt_onUnLoad => "hideHelpButton();setAnswers(group,'#{clinical_question}');",
                           :condition => "'#{group}'.match(group)",
                           :id => "#{clinical_question}",
                           :allowFreeText => false
            %>

            <%#= hidden_field_tag("observations[][concept_name]", "concept_name_2") %>
            <%#= select_tag "observations[][value_coded_or_text]", options_for_select(['','Yes','No'] , @current_data['CLINICAL ASSESSMENT']),
                           :helpText =>'Another Question comes here.',
                           :condition => "$('clinical_question').value == 'Yes';",
                           :tt_onLoad => 'showHelpButton();',
                           :tt_onUnLoad => 'hideHelpButton();',
                           :id => 'clinical_assessment',
                           :allowFreeText => false
            %>
        <% end %>
    <% end %>
    <%= text_field_tag 'summary', nil,
                       :helpText => 'Clinic Assessment Summary',
                       :tt_onLoad => "$('keyboard').style.display = 'none';getAnswers();loadSummary();",
                       :optional => true
    %>
<% end %>